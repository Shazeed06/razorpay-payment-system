<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - Payments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 24px;
    }
    .sub {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .top-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: #22c55e;
      color: #022c22;
    }
    .btn-secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: #020617;
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid #1f2937;
    }
    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }
    .stat-sub {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }
    .filters {
      background: #020617;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #1f2937;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }
    .filters input {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }
    .filters input:focus {
      outline: none;
      border-color: #22c55e;
    }
    .filters label {
      font-size: 12px;
      color: #9ca3af;
    }
    .table-wrap {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      background: #020617;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #111827;
    }
    th {
      text-align: left;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: #020617;
    }
    tbody tr:nth-child(odd) {
      background: #020617;
    }
    .status-pill {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .status-paid {
      background: #22c55e33;
      color: #bbf7d0;
    }
    .status-created {
      background: #facc1533;
      color: #fef9c3;
    }
    .status-other {
      background: #6b728033;
      color: #e5e7eb;
    }
    .amount {
      font-variant-numeric: tabular-nums;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
      font-size: 10px;
    }
    .scroll {
      max-height: 420px;
      overflow: auto;
    }
    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }
    .status-text {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #9ca3af;
    }
    @media (max-width: 640px) {
      .table-wrap {
        border-radius: 8px;
      }
      th, td {
        padding: 6px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div>
        <h1>Admin Dashboard</h1>
        <div class="sub">All Razorpay payments (from SQLite DB) in one place.</div>
      </div>
      <div class="top-actions">
        <button class="btn btn-secondary" onclick="window.location.href='/'">
          ⬅ User Payment Page
        </button>
        <button class="btn btn-primary" onclick="window.location.href='/api/payments/export'">
          ⬇ Download Excel
        </button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Payments</div>
        <div class="stat-value" id="statTotalCount">0</div>
        <div class="stat-sub">All records (CREATED + PAID)</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Collected (₹)</div>
        <div class="stat-value" id="statTotalPaidAmount">0</div>
        <div class="stat-sub">Sum of PAID only</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Paid / Created</div>
        <div class="stat-value" id="statPaidRatio">0 / 0</div>
        <div class="stat-sub">Successful vs total</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Last Payment</div>
        <div class="stat-value" id="statLastPayment">—</div>
        <div class="stat-sub" id="statLastPaymentStatus">No payments yet</div>
      </div>
    </div>

    <div class="filters">
      <div>
        <label for="search">Search (name / email / phone / order ID)</label>
        <input id="search" type="text" placeholder="Type to filter..." />
      </div>
      <div>
        <label for="statusFilter">Status</label>
        <select id="statusFilter" style="padding:6px 10px;border-radius:8px;border:1px solid #1f2937;background:#020617;color:#e5e7eb;font-size:13px;">
          <option value="all">All</option>
          <option value="PAID">PAID only</option>
          <option value="CREATED">CREATED only</option>
        </select>
      </div>
      <div class="status-text" id="loadStatus">
        <span class="badge-dot" id="statusDot"></span>
        <span id="statusMsg">Loading data...</span>
      </div>
    </div>

    <div class="table-wrap">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Created At</th>
              <th>Name</th>
              <th>Contact</th>
              <th>Amount (₹)</th>
              <th>Status</th>
              <th>Order ID</th>
              <th>Payment ID</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "/api/payments";


    const tableBody = document.getElementById("tableBody");
    const searchInput = document.getElementById("search");
    const statusFilter = document.getElementById("statusFilter");
    const statTotalCount = document.getElementById("statTotalCount");
    const statTotalPaidAmount = document.getElementById("statTotalPaidAmount");
    const statPaidRatio = document.getElementById("statPaidRatio");
    const statLastPayment = document.getElementById("statLastPayment");
    const statLastPaymentStatus = document.getElementById("statLastPaymentStatus");
    const statusDot = document.getElementById("statusDot");
    const statusMsg = document.getElementById("statusMsg");

    let allPayments = [];

    function setStatus(text, isError = false) {
      statusMsg.textContent = text;
      statusDot.style.background = isError ? "#ef4444" : "#22c55e";
    }

    function formatDate(iso) {
      if (!iso) return "—";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString();
    }

    function formatAmount(amountRupees) {
      if (amountRupees == null) return "—";
      return Number(amountRupees).toFixed(2);
    }

    function buildRow(item, index) {
      const tr = document.createElement("tr");

      const status = (item.status || "").toUpperCase();
      let statusClass = "status-other";
      if (status === "PAID") statusClass = "status-paid";
      else if (status === "CREATED") statusClass = "status-created";

      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${formatDate(item.created_at)}</td>
        <td>
          ${item.customer_name || "—"}
          ${item.customer_email ? `<div class="tag">${item.customer_email}</div>` : ""}
        </td>
        <td>
          ${item.customer_contact || "—"}
        </td>
        <td class="amount">₹ ${formatAmount(item.amount_rupees)}</td>
        <td>
          <span class="status-pill ${statusClass}">${status || "UNKNOWN"}</span>
        </td>
        <td style="max-width:230px;word-break:break-all;">${item.razorpay_order_id || "—"}</td>
        <td style="max-width:230px;word-break:break-all;">${item.razorpay_payment_id || "—"}</td>
      `;
      return tr;
    }

    function applyFilters() {
      const q = searchInput.value.trim().toLowerCase();
      const statusValue = statusFilter.value;

      const filtered = allPayments.filter(item => {
        const status = (item.status || "").toUpperCase();
        if (statusValue !== "all" && status !== statusValue) return false;

        if (!q) return true;

        const haystack = [
          item.customer_name,
          item.customer_email,
          item.customer_contact,
          item.razorpay_order_id,
          item.razorpay_payment_id
        ]
          .filter(Boolean)
          .join(" ")
          .toLowerCase();

        return haystack.includes(q);
      });

      // render table
      tableBody.innerHTML = "";
      filtered.forEach((item, idx) => {
        tableBody.appendChild(buildRow(item, idx));
      });

      // update small inline status
      if (filtered.length === 0) {
        setStatus("No records found with current filter.");
      } else {
        setStatus(`Showing ${filtered.length} of ${allPayments.length} records.`);
      }
    }

    function updateStats() {
      const total = allPayments.length;
      const paid = allPayments.filter(p => (p.status || "").toUpperCase() === "PAID");
      const totalPaidAmount = paid.reduce((sum, p) => sum + (p.amount_rupees || 0), 0);

      statTotalCount.textContent = total;
      statTotalPaidAmount.textContent = totalPaidAmount.toFixed(2);
      statPaidRatio.textContent = `${paid.length} / ${total}`;

      if (allPayments.length > 0) {
        // assuming listPayments sorted DESC by id, so index 0 is latest
        const last = allPayments[0];
        statLastPayment.textContent = `₹ ${formatAmount(last.amount_rupees)}`;
        statLastPaymentStatus.textContent = `${(last.status || "").toUpperCase()} • ${formatDate(last.created_at)}`;
      } else {
        statLastPayment.textContent = "—";
        statLastPaymentStatus.textContent = "No payments yet";
      }
    }

    async function fetchPayments() {
      try {
        setStatus("Loading data...");
        const res = await fetch(API_BASE + "/records");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || "Failed to fetch");

        // ensure amount_rupees exists; if not, derive
        allPayments = (data.payments || []).map(p => ({
          ...p,
          amount_rupees: p.amount_rupees != null ? p.amount_rupees : (p.amount != null ? p.amount / 100 : null)
        }));

        updateStats();
        applyFilters();
      } catch (err) {
        console.error(err);
        setStatus("Failed to load data: " + err.message, true);
      }
    }

    searchInput.addEventListener("input", () => {
      applyFilters();
    });

    statusFilter.addEventListener("change", () => {
      applyFilters();
    });

    // initial load
    fetchPayments();
  </script>
</body>
</html>
